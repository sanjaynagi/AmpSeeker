import pandas as pd
import numpy as np
import json
import os
wkdir = os.getcwd()

include: "rules/metadata.smk"
configfile: "config/config.yaml"

dataset = config["dataset"]
panel = config["panel"]
cohort_cols = ','.join(config['cohort-columns'])

metadata_path = config['metadata'] if not config['from-bcl'] else config['illumina-dir'] + "/SampleSheet.csv"
metadata = load_metadata(metadata_path, write=True, from_sample_sheet=config['from-bcl'])

if config['platform'] == "nanopore":
    assert 'fq1' in metadata.columns, "The fq1 column in the metadata does not seem to exist. For nanopore data, this column is required and should point to FASTQ files."
    fastq_auto = False if all(col in metadata.columns for col in ['fq1']) else True
    call_types = ["amplicons"]
elif config['platform'] == "illumina":
    fastq_auto = False if all(col in metadata.columns for col in ['fq1', 'fq2']) else True
    call_types = ["targets", "amplicons"]
else:
    raise ValueError(f"Unsupported platform: expected 'illumina' or 'nanopore', got '{platform}'")

plate_info = np.isin(["plate", "well_letter", "well_number"], metadata.columns).all()
samples = metadata["sample_id"]

include: "rules/common.smk"
welcome(version="v0.6")
include: "rules/utilities.smk"
include: "rules/bcl-convert.smk"
include: "rules/qc.smk"

if config['platform'] == ["illumina", "miseq"]:
    include: "rules/map-call-illumina.smk"
elif config['platform'] in ["nanopore", "ont"]:
    include: "rules/map-call-nanopore.smk"

include: "rules/qc-notebooks.smk"
include: "rules/snpeff.smk"
include: "rules/analysis.smk"
include: "rules/jupyter-book.smk"

if panel == "ag-vampir":
    include: "rules/ag-vampir.smk"

color_mappings = create_color_mapping(metadata, columns=config['cohort-columns'])
os.makedirs("results/config", exist_ok=True)
with open(f"results/config/metadata_colours.json", 'w') as f:
    json.dump(color_mappings, f, indent=2)


rule all:
    input:
        AmpSeekerOutputs,

